{% extends "base.html" %}

{% block content %}
<div class="topbar">
    <h1>{% if bolsista %}Editar Bolsista{% else %}Novo Bolsista{% endif %}</h1>
    <a href="{{ url_for('bolsistas_index') }}" class="btn" style="background-color: #e5e7eb;">Voltar</a>
</div>

<form method="POST" class="card" style="max-width: 900px;">
    {% if bolsista %}
    <div
        style="margin-bottom: 1.5rem; padding: 1rem; background-color: var(--card-bg); border: 1px solid var(--border-color); border-radius: 0.375rem; color: var(--text-color);">
        <label style="display:flex; align-items:center;">
            <input type="checkbox" name="ativo" style="margin-right: 0.5rem;" {% if bolsista.ativo %}checked{% endif %}>
            <strong>Bolsista Ativo</strong>
        </label>
    </div>
    {% endif %}

    <!-- SECTION 1: VÍNCULO -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Vínculo</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Edital</label>
            <select name="edital_id" id="edital_select" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-color);">
                <option value="">Selecione...</option>
                {% for edital in editais %}
                <option value="{{ edital.id }}" {% if bolsista and bolsista.edital_id==edital.id %}selected{% endif %}>
                    {{ edital.numero }} - {{ edital.agencia }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Modalidade/Nível</label>
            <select name="modalidade_id" id="modalidade_select" required disabled
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-color);">
                <option value="">Selecione um edital primeiro</option>
            </select>
        </div>
    </div>

    <!-- SECTION 2: DADOS PESSOAIS -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados Pessoais</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem;">Nome Completo</label>
            <input type="text" name="nome" value="{{ bolsista.nome if bolsista else '' }}" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">CPF</label>
            <input type="text" name="cpf" value="{{ bolsista.cpf if bolsista else '' }}" required
                placeholder="000.000.000-00"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">E-mail</label>
            <input type="email" name="email" value="{{ bolsista.email if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
    </div>

    <!-- SECTION 3: DADOS ACADÊMICOS -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados Acadêmicos</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Programa</label>
            <input type="text" name="programa" value="{{ bolsista.programa if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Campus</label>
            <select name="campus" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-color);">
                <option value="">Selecione...</option>
                {% set campi = ['Apucarana', 'Campo Mourão', 'Cornélio Procópio', 'Curitiba', 'Dois Vizinhos',
                'Francisco Beltrão', 'Guarapuava', 'Londrina', 'Medianeira', 'Pato Branco', 'Ponta Grossa', 'Santa
                Helena', 'Toledo'] %}
                {% for c in campi %}
                <option value="{{ c }}" {% if bolsista and bolsista.campus==c %}selected{% endif %}>{{ c }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="grid-column: span 2;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">Orientador</label>
                    <input type="text" name="orientador" value="{{ bolsista.orientador if bolsista else '' }}"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.5rem;">Email do Orientador</label>
                    <input type="email" name="email_orientador"
                        value="{{ bolsista.email_orientador if bolsista and bolsista.email_orientador else '' }}"
                        style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
                </div>
            </div>
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Início do Curso</label>
            <input type="date" name="data_inicio_curso" value="{{ bolsista.data_inicio_curso if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Previsão de Defesa</label>
            <input type="date" name="previsao_defesa" value="{{ bolsista.previsao_defesa if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
    </div>

    <!-- SECTION 4: DADOS BANCÁRIOS -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados Bancários</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem;">Banco</label>
            <input type="text" name="banco" value="{{ bolsista.banco if bolsista else '' }}"
                placeholder="Ex: Banco do Brasil"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Agência</label>
            <input type="text" name="agencia" value="{{ bolsista.agencia if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Conta</label>
            <input type="text" name="conta" value="{{ bolsista.conta if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div style="grid-column: span 4;">
            <label style="display: block; margin-bottom: 0.5rem;">Tipo de Conta</label>
            <select name="tipo_conta"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
                <option value="corrente" {% if bolsista and bolsista.tipo_conta=='corrente' %}selected{% endif %}>
                    Corrente</option>
                <option value="poupanca" {% if bolsista and bolsista.tipo_conta=='poupanca' %}selected{% endif %}>
                    Poupança</option>
            </select>
        </div>
    </div>

    <!-- SECTION 5: BOLSA -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados da Bolsa</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Início da Bolsa</label>
            <input type="date" name="data_inicio_bolsa" value="{{ bolsista.data_inicio_bolsa if bolsista else '' }}"
                required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Meses de Duração</label>
            <input type="number" name="meses_duracao" value="{{ bolsista.meses_duracao if bolsista else '' }}" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Fim da Bolsa</label>
            <input type="date" name="data_fim_bolsa" value="{{ bolsista.data_fim_bolsa if bolsista else '' }}" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
    </div>

    <div style="margin-bottom: 1rem;">
        <label style="display: block; margin-bottom: 0.5rem;">Processo SEI</label>
        <input type="text" name="processo_sei"
            value="{{ bolsista.processo_sei if bolsista and bolsista.processo_sei else '' }}"
            style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
    </div>

    <div style="margin-bottom: 2rem;">
        <label style="display: block; margin-bottom: 0.5rem;">Comentários</label>
        <textarea name="comentarios" rows="3"
            style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">{{ bolsista.comentarios if bolsista and bolsista.comentarios else '' }}</textarea>
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
        {% if bolsista %}Atualizar Bolsista{% else %}Cadastrar Bolsista{% endif %}
    </button>
</form>

<script>
    const editalSelect = document.getElementById('edital_select');
    const modalidadeSelect = document.getElementById('modalidade_select');

    editalSelect.addEventListener('change', function () {
        const editalId = this.value;
        loadModalidades(editalId);
    });

    // Warning Element
    const warningDiv = document.createElement('div');
    warningDiv.style.color = '#7f1d1d';
    warningDiv.style.backgroundColor = '#fecaca';
    warningDiv.style.padding = '0.75rem';
    warningDiv.style.borderRadius = '0.375rem';
    warningDiv.style.marginTop = '0.5rem';
    warningDiv.style.display = 'none';

    // Insert warning after meses_duracao input's parent div
    mesesDuracao.parentNode.appendChild(warningDiv);

    function loadModalidades(editalId, selectedModalidadeId = null) {
        modalidadeSelect.innerHTML = '<option value="">Carregando...</option>';
        modalidadeSelect.disabled = true;

        if (editalId) {
            fetch(`/api/modalidades/${editalId}`)
                .then(response => response.json())
                .then(data => {
                    modalidadeSelect.innerHTML = '<option value="">Selecione...</option>';
                    data.forEach(mod => {
                        const selected = (selectedModalidadeId && selectedModalidadeId == mod.id) ? 'selected' : '';
                        // Store max_meses in data attribute
                        modalidadeSelect.innerHTML += `<option value="${mod.id}" data-max-meses="${mod.max_meses || ''}" ${selected}>${mod.nivel} - R$ ${mod.valor}</option>`;
                    });
                    modalidadeSelect.disabled = false;
                });
        } else {
            modalidadeSelect.innerHTML = '<option value="">Selecione um edital primeiro</option>';
            modalidadeSelect.disabled = true;
        }
    }

    // Logic: Calculate Duration based on Course Start, Scholarship Start and Max Months
    function autoCalculateDuration() {
        const selectedOption = modalidadeSelect.options[modalidadeSelect.selectedIndex];
        const maxMeses = selectedOption ? parseInt(selectedOption.getAttribute('data-max-meses')) : null;

        // Ensure both dates are present
        if (!dataInicioCurso.value || !dataInicioBolsa.value) return;

        // If no max months defined for modality, default logic (just rely on user input or existing logic)
        if (!maxMeses) return;

        const startCourse = new Date(dataInicioCurso.value);
        const startScholarship = new Date(dataInicioBolsa.value);

        // Calculate months elapsed between Course Start and Scholarship Start
        // Formula: (Year2 - Year1) * 12 + (Month2 - Month1)
        let monthsElapsed = (startScholarship.getFullYear() - startCourse.getFullYear()) * 12;
        monthsElapsed -= startCourse.getMonth();
        monthsElapsed += startScholarship.getMonth();

        // If started scholarship before course (weird but possible), elapsed is 0 or negative
        if (monthsElapsed < 0) monthsElapsed = 0;

        const remainingMonths = maxMeses - monthsElapsed;

        if (remainingMonths <= 0) {
            // Warn user
            warningDiv.innerHTML = `<strong>Atenção:</strong> O prazo regular desta modalidade (${maxMeses} meses) já foi excedido pelo tempo de curso (${monthsElapsed} meses decorridos).`;
            warningDiv.style.display = 'block';
            mesesDuracao.value = 0;
        } else {
            // Set duration to remaining
            mesesDuracao.value = remainingMonths;
            warningDiv.style.display = 'none';
            // Also trigger end date calc
            updateEndDate();
        }
    }

    function updateEndDate() {
        if (!dataInicioBolsa.value || !mesesDuracao.value) return;

        const start = new Date(dataInicioBolsa.value);
        const months = parseInt(mesesDuracao.value);

        // Helper to add months correctly handling end-of-month logic
        // But for simplicity: Start Date + Months - 1 Day
        // Example: Start 01/03/2024, 12 months -> End 28/02/2025

        let end = new Date(start);
        end.setMonth(end.getMonth() + months);
        end.setDate(end.getDate() - 1);

        dataFimBolsa.value = end.toISOString().split('T')[0];
    }

    // Listeners
    dataInicioCurso.addEventListener('change', autoCalculateDuration);
    dataInicioBolsa.addEventListener('change', () => {
        autoCalculateDuration();
        updateEndDate(); // If max months logic doesn't apply, still calc end date
    });
    modalidadeSelect.addEventListener('change', autoCalculateDuration);

    mesesDuracao.addEventListener('input', updateEndDate); // Manual override update end date

    // Insert after data_fim_bolsa
    dataFimBolsa.parentNode.appendChild(warningDiv);

    function calculateDates() {
        if (dataInicioBolsa.value && mesesDuracao.value) {
            const start = new Date(dataInicioBolsa.value);
            const months = parseInt(mesesDuracao.value);

            // Calculate End Date: Start + Months
            const end = new Date(start);
            end.setMonth(start.getMonth() + months);
            // Subtract 1 day to be exact? E.g. 01/01 to 01/02 is 1 month, ends 31/01 or 01/02?
            end.setDate(end.getDate() - 1);

            dataFimBolsa.value = end.toISOString().split('T')[0];

            checkCourseLimit(end);
        }
    }

    function checkCourseLimit(bolsaEndDate) {
        if (dataInicioCurso.value) {
            const courseStart = new Date(dataInicioCurso.value);
            // 24 months limit
            const courseLimit = new Date(courseStart);
            courseLimit.setMonth(courseStart.getMonth() + 24);

            if (bolsaEndDate > courseLimit) {
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }
    }

    dataInicioBolsa.addEventListener('change', calculateDates);
    mesesDuracao.addEventListener('input', calculateDates);
    dataInicioCurso.addEventListener('change', function () {
        if (dataFimBolsa.value) {
            checkCourseLimit(new Date(dataFimBolsa.value));
        }
    });

    // Run on load if editing
    {% if bolsista %}
    if (dataInicioCurso.value && dataFimBolsa.value) {
        checkCourseLimit(new Date(dataFimBolsa.value));
    }
    {% endif %}
</script>
{% endblock %}