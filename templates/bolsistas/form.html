{% extends "base.html" %}

{% block content %}
<div class="topbar">
    <h1>{% if bolsista %}Editar Bolsista{% else %}Novo Bolsista{% endif %}</h1>
    <a href="{{ url_for('bolsistas_index') }}" class="btn" style="background-color: #e5e7eb;">Voltar</a>
</div>

<form method="POST" class="card" style="max-width: 900px;">
    {% if bolsista %}
    <div style="margin-bottom: 1.5rem; padding: 1rem; background-color: #f3f4f6; border-radius: 0.375rem;">
        <label style="display:flex; align-items:center;">
            <input type="checkbox" name="ativo" style="margin-right: 0.5rem;" {% if bolsista.ativo %}checked{% endif %}>
            <strong>Bolsista Ativo</strong>
        </label>
    </div>
    {% endif %}

    <!-- SECTION 1: VÍNCULO -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Vínculo</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Edital</label>
            <select name="edital_id" id="edital_select" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-color);">
                <option value="">Selecione...</option>
                {% for edital in editais %}
                <option value="{{ edital.id }}" {% if bolsista and bolsista.edital_id==edital.id %}selected{% endif %}>
                    {{ edital.numero }} - {{ edital.agencia }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Modalidade/Nível</label>
            <select name="modalidade_id" id="modalidade_select" required disabled
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem; background: var(--card-bg); color: var(--text-color);">
                <option value="">Selecione um edital primeiro</option>
            </select>
        </div>
    </div>

    <!-- SECTION 2: DADOS PESSOAIS -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados Pessoais</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem;">Nome Completo</label>
            <input type="text" name="nome" value="{{ bolsista.nome if bolsista else '' }}" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">CPF</label>
            <input type="text" name="cpf" value="{{ bolsista.cpf if bolsista else '' }}" required
                placeholder="000.000.000-00"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">E-mail</label>
            <input type="email" name="email" value="{{ bolsista.email if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
    </div>

    <!-- SECTION 3: DADOS ACADÊMICOS -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados Acadêmicos</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Programa</label>
            <input type="text" name="programa" value="{{ bolsista.programa if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Campus</label>
            <input type="text" name="campus" value="{{ bolsista.campus if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem;">Orientador</label>
            <input type="text" name="orientador" value="{{ bolsista.orientador if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Início do Curso</label>
            <input type="date" name="data_inicio_curso" value="{{ bolsista.data_inicio_curso if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Previsão de Defesa</label>
            <input type="date" name="previsao_defesa" value="{{ bolsista.previsao_defesa if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
    </div>

    <!-- SECTION 4: DADOS BANCÁRIOS -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados Bancários</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
        <div style="grid-column: span 2;">
            <label style="display: block; margin-bottom: 0.5rem;">Banco</label>
            <input type="text" name="banco" value="{{ bolsista.banco if bolsista else '' }}"
                placeholder="Ex: Banco do Brasil"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Agência</label>
            <input type="text" name="agencia" value="{{ bolsista.agencia if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Conta</label>
            <input type="text" name="conta" value="{{ bolsista.conta if bolsista else '' }}"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div style="grid-column: span 4;">
            <label style="display: block; margin-bottom: 0.5rem;">Tipo de Conta</label>
            <select name="tipo_conta"
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
                <option value="corrente" {% if bolsista and bolsista.tipo_conta=='corrente' %}selected{% endif %}>
                    Corrente</option>
                <option value="poupanca" {% if bolsista and bolsista.tipo_conta=='poupanca' %}selected{% endif %}>
                    Poupança</option>
            </select>
        </div>
    </div>

    <!-- SECTION 5: BOLSA -->
    <h3 style="margin-bottom: 1rem; color: var(--primary-color);">Dados da Bolsa</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Início da Bolsa</label>
            <input type="date" name="data_inicio_bolsa" value="{{ bolsista.data_inicio_bolsa if bolsista else '' }}"
                required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Meses de Duração</label>
            <input type="number" name="meses_duracao" value="{{ bolsista.meses_duracao if bolsista else '' }}" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
        <div>
            <label style="display: block; margin-bottom: 0.5rem;">Fim da Bolsa</label>
            <input type="date" name="data_fim_bolsa" value="{{ bolsista.data_fim_bolsa if bolsista else '' }}" required
                style="width: 100%; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 0.375rem;">
        </div>
    </div>

    <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem; font-size: 1.1rem;">
        {% if bolsista %}Atualizar Bolsista{% else %}Cadastrar Bolsista{% endif %}
    </button>
</form>

<script>
    const editalSelect = document.getElementById('edital_select');
    const modalidadeSelect = document.getElementById('modalidade_select');

    editalSelect.addEventListener('change', function () {
        const editalId = this.value;
        loadModalidades(editalId);
    });

    function loadModalidades(editalId, selectedModalidadeId = null) {
        modalidadeSelect.innerHTML = '<option value="">Carregando...</option>';
        modalidadeSelect.disabled = true;

        if (editalId) {
            fetch(`/api/modalidades/${editalId}`)
                .then(response => response.json())
                .then(data => {
                    modalidadeSelect.innerHTML = '<option value="">Selecione...</option>';
                    data.forEach(mod => {
                        const selected = (selectedModalidadeId && selectedModalidadeId == mod.id) ? 'selected' : '';
                        modalidadeSelect.innerHTML += `<option value="${mod.id}" ${selected}>${mod.nivel} - R$ ${mod.valor}</option>`;
                    });
                    modalidadeSelect.disabled = false;
                });
        } else {
            modalidadeSelect.innerHTML = '<option value="">Selecione um edital primeiro</option>';
            modalidadeSelect.disabled = true;
        }
    }

    // Pre-load if editing
    {% if bolsista %}
    loadModalidades({{ bolsista.edital_id }}, {{ bolsista.modalidade_id }});
    {% endif %}

    // Date Logic
    const dataInicioCurso = document.querySelector('input[name="data_inicio_curso"]');
    const dataInicioBolsa = document.querySelector('input[name="data_inicio_bolsa"]');
    const mesesDuracao = document.querySelector('input[name="meses_duracao"]');
    const dataFimBolsa = document.querySelector('input[name="data_fim_bolsa"]');

    // Warning Element
    const warningDiv = document.createElement('div');
    warningDiv.style.color = '#b91c1c';
    warningDiv.style.backgroundColor = '#fecaca';
    warningDiv.style.padding = '0.5rem';
    warningDiv.style.borderRadius = '0.375rem';
    warningDiv.style.marginTop = '0.5rem';
    warningDiv.style.display = 'none';
    warningDiv.innerHTML = '<strong>Atenção:</strong> A bolsa excede o período regular do curso (24 meses).';

    // Insert after data_fim_bolsa
    dataFimBolsa.parentNode.appendChild(warningDiv);

    function calculateDates() {
        if (dataInicioBolsa.value && mesesDuracao.value) {
            const start = new Date(dataInicioBolsa.value);
            const months = parseInt(mesesDuracao.value);

            // Calculate End Date: Start + Months
            const end = new Date(start);
            end.setMonth(start.getMonth() + months);
            // Subtract 1 day to be exact? E.g. 01/01 to 01/02 is 1 month, ends 31/01 or 01/02?
            end.setDate(end.getDate() - 1);

            dataFimBolsa.value = end.toISOString().split('T')[0];

            checkCourseLimit(end);
        }
    }

    function checkCourseLimit(bolsaEndDate) {
        if (dataInicioCurso.value) {
            const courseStart = new Date(dataInicioCurso.value);
            // 24 months limit
            const courseLimit = new Date(courseStart);
            courseLimit.setMonth(courseStart.getMonth() + 24);

            if (bolsaEndDate > courseLimit) {
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }
    }

    dataInicioBolsa.addEventListener('change', calculateDates);
    mesesDuracao.addEventListener('input', calculateDates);
    dataInicioCurso.addEventListener('change', function () {
        if (dataFimBolsa.value) {
            checkCourseLimit(new Date(dataFimBolsa.value));
        }
    });

    // Run on load if editing
    {% if bolsista %}
    if (dataInicioCurso.value && dataFimBolsa.value) {
        checkCourseLimit(new Date(dataFimBolsa.value));
    }
    {% endif %}
</script>
{% endblock %}